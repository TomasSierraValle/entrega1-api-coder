<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <title>{{title}}</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />

  <!-- Bootstrap -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">

  <!-- Tus estilos opcionales -->
  <link rel="stylesheet" href="/public/styles.css" />
</head>
<body class="bg-light">

  <nav class="navbar navbar-expand-lg navbar-dark bg-dark mb-4">
    <div class="container">
      <a class="navbar-brand" href="/products">Supermercado</a>
      <div class="ms-auto d-flex gap-2">
        <a class="btn btn-outline-light" href="/products">Productos</a>
        <!-- Botón que resuelve /carts/:cid desde localStorage (o crea uno si no existe) -->
        <a id="cartLink" class="btn btn-warning" href="#">Ver Carrito</a>
      </div>
    </div>
  </nav>

  <main class="container">
    {{{body}}}
  </main>

  <!-- Bootstrap JS -->
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>

  <script>
    (function () {
      const link = document.getElementById('cartLink');
      if (!link) return;

      link.addEventListener('click', async (e) => {
        e.preventDefault();
        try {
          let cid = localStorage.getItem('cartId');

          // Si no hay carrito, lo creamos via API
          if (!cid) {
            const r = await fetch('/api/carts', { method: 'POST' });
            const j = await r.json();
            if (j.status !== 'success' || !j.payload?._id) {
              alert('No se pudo crear el carrito');
              return;
            }
            cid = j.payload._id;
            localStorage.setItem('cartId', cid);
          }

          // Redirige a la vista del carrito
          window.location.href = `/carts/${cid}`;
        } catch (err) {
          console.error('Error al abrir carrito:', err);
          alert('Ocurrió un error al abrir el carrito');
        }
      });
    })();
  </script>
</body>
</html>
